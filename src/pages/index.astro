---
import Layout from '../layouts/Layout.astro';
import { Chart } from '../components/chart';
import Footer from '@/components/footer.astro';
import Header from '@/components/header.astro';
import { db } from '@/db';
import { combineTVLs } from '../tvl';
import { ProtocolRankingRow } from '@/components/protocol-ranking';

const rocketPoolTVL = await db.rocketPool.findMany({
  orderBy: {
    block_number: 'asc'
  }
});

const etherFi = await db.etherFi.findMany({
  orderBy: {
    block_number: 'asc'
  }
});

const stakeWiseDB = await db.stakeWise.findMany({
  orderBy: {
    block_number: 'asc'
  }
});

const vaultTVLChanges = stakeWiseDB.map((value) => {
  return {
    ...value,
    eth: BigInt(value.eth)
  };
});

type TVLValue = {
  block_timestamp: bigint;
  eth: bigint;
};

const stakeWiseTVL: TVLValue[] = [];

stakeWiseTVL[0] = vaultTVLChanges[0];

for (let i = 1; i < vaultTVLChanges.length; i++) {
  stakeWiseTVL[i] = {
    eth: vaultTVLChanges[i].eth + stakeWiseTVL[i - 1].eth,
    block_timestamp: vaultTVLChanges[i].block_timestamp
  };
}

const stakeWise = stakeWiseTVL.map((value) => ({ ...value, eth: value.eth.toString() }));

const TVLFinal = combineTVLs([rocketPoolTVL, etherFi, stakeWise]);
const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
---

<Layout>
  <div class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
    <div class="max-w-[1070px] mx-auto">
      <Header />
      <Chart
        client:only="react"
        data={TVLFinal.map((item) => ({
          date: (() => {
            const date = new Date(item.timestamp);
            return MONTHS[date.getMonth()] + ' ' + date.getDate();
          })(),
          timestamp: item.timestamp,
          ETH: Math.round(Number(item.value) / 1e18)
        }))}
      />
      <!-- <div
        class="bg-[#191919] rounded flex items-center justify-between md:h-[140px] flex-wrap md:flex-nowrap border border-white border-opacity-10"
      >
        <div class="flex flex-col items-start justify-center gap-1 p-8 w-full md:w-[25%]">
          <div class="font-mono font-bold text-xs opacity-50">ETH STAKED</div>
          <div class="font-semibold text-2xl">Îž {rocketPoolETHStaked}</div>
        </div>
        <div class="w-[1px] h-[140px] bg-white bg-opacity-10 md:block hidden"></div>
        <div
          class="flex flex-col items-start justify-center gap-1 p-8 w-full md:w-[25%] md:border-t-0 border-t border-white border-opacity-10"
        >
          <div class="font-mono font-bold text-xs opacity-50">VALIDATORS</div>
          <div class="font-semibold text-2xl">???</div>
        </div>
        <div class="w-[1px] h-[140px] bg-white bg-opacity-10 md:block hidden"></div>
        <div
          class="flex flex-col items-start justify-center gap-1 p-8 w-full md:w-[25%] md:border-t-0 border-t border-white border-opacity-10"
        >
          <div class="font-mono font-bold text-xs opacity-50">STAKED SHARE OF ETH</div>
          <div class="font-semibold text-2xl">???</div>
        </div>
        <div class="w-[1px] h-[140px] bg-white bg-opacity-10 md:block hidden"></div>
        <div
          class="flex flex-col items-start justify-center gap-1 p-8 w-full md:w-[25%] md:border-t-0 border-t border-white border-opacity-10"
        >
          <div class="font-mono font-bold text-xs opacity-50">LIDO DOMINANCE</div>
          <div class="font-semibold text-2xl">???</div>
        </div>
      </div> -->
      <div class="mt-32">
        <div class="flex items-center justify-between flex-wrap gap-8">
          <div>
            <h2 class="text-3xl font-medium mb-2">Protocol Rankings</h2>
            <div class="text-xl font-light opacity-70">
              <span class="block"> The top 10 protocols by total value locked. </span>
            </div>
          </div>
        </div>
        <div
          class="max-w-[100vw] overflow-x-auto mt-8 mb-32 border border-white border-opacity-10 rounded"
        >
          <table class="w-full overflow-hidden">
            <thead
              class="bg-[#242424] font-mono text-[#949494] border-b border-white border-opacity-10"
            >
              <tr>
                <th
                  class="text-left text-sm font-medium p-4 border-r border-white border-opacity-10"
                  >PROTOCOL
                </th>
                <th
                  class="text-left text-sm font-medium p-4 border-r border-white border-opacity-10"
                  >24H Volume
                </th>
                <th
                  class="text-right text-sm font-medium p-4 border-r border-white border-opacity-10"
                >
                  TVL (ETH)
                </th>
              </tr>
            </thead>
            <tbody class="bg-[#191919]">
              <ProtocolRankingRow label="RocketPool" values={rocketPoolTVL} />
              <ProtocolRankingRow label="EtherFi" values={etherFi} />
              <ProtocolRankingRow label="StakeWise (v3)" values={stakeWise} />
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <Footer />
</Layout>
